<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime Network Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <style>
      body {
        background-color: #f4f6f9;
      }
      .card-counter {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        transition: 0.3s;
      }
      .card-counter:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }
      .card-counter i {
        font-size: 3.5em;
        opacity: 0.1;
        position: absolute;
        right: 15px;
        top: 15px;
      }
      .card-counter .count-numbers {
        font-size: 32px;
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      .card-counter .count-name {
        opacity: 0.7;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
      }
      
      .border-left-primary {
        border-left: 4px solid #0d6efd;
      }
      .border-left-success {
        border-left: 4px solid #198754;
      }
      .border-left-danger {
        border-left: 4px solid #dc3545;
      }
      
      /* Animasi kedip untuk Live Mode */
      .live-indicator {
        height: 10px;
        width: 10px;
        background-color: #dc3545;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 rgba(220, 53, 69, 0.4);
        animation: pulse 1.5s infinite;
        margin-right: 5px;
        display: none; /* Hidden by default */
      }
      @keyframes pulse {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 6px rgba(220, 53, 69, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3 shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="bi bi-activity"></i> NetMonitor</a>
        <div class="d-flex align-items-center">
          <span class="live-indicator" id="liveIndicator"></span>
          <span class="text-white small" id="statusText">Ready</span>
        </div>
        <button class="btn btn-info text-white shadow-sm" onclick="askAI()"><i class="bi bi-robot"></i> Analisa AI</button>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row mb-4 align-items-center">
        <div class="col-md-8">
          <div class="row">
            <div class="col-md-4 mb-2">
              <div class="card-counter border-left-primary">
                <i class="bi bi-hdd-network"></i>
                <span class="count-numbers" id="total-count">{{ hosts|length }}</span>
                <span class="count-name">Total Devices</span>
              </div>
            </div>
            <div class="col-md-4 mb-2">
              <div class="card-counter border-left-success">
                <i class="bi bi-check-circle"></i>
                <span class="count-numbers text-success" id="online-count">0</span>
                <span class="count-name">Online</span>
              </div>
            </div>
            <div class="col-md-4 mb-2">
              <div class="card-counter border-left-danger">
                <i class="bi bi-x-circle"></i>
                <span class="count-numbers text-danger" id="offline-count">0</span>
                <span class="count-name">Offline</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body bg-light rounded">
              <h6 class="text-muted mb-3"><i class="bi bi-clock-history"></i> Pengaturan Realtime</h6>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" />
                <label class="form-check-label fw-bold" for="autoRefreshSwitch">Live Mode (Auto Refresh)</label>
              </div>
              <div class="input-group input-group-sm">
                <span class="input-group-text">Interval</span>
                <select class="form-select" id="refreshInterval">
                  <option value="5000">5 Detik</option>
                  <option value="10000" selected>10 Detik</option>
                  <option value="30000">30 Detik</option>
                  <option value="60000">1 Menit</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-secondary"><i class="bi bi-list-task"></i> Monitoring List</h5>
          <div>
            <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addModal"><i class="bi bi-plus-lg"></i> Tambah</button>
            <button onclick="manualCheck()" id="btnManualRefresh" class="btn btn-primary btn-sm"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Device Name</th>
                  <th>IP Address</th>
                  <th>Last Checked</th>
                  <th class="text-center">Status</th>
                  <th class="text-center">Aksi</th>
                </tr>
              </thead>
              <tbody>
                {% for host in hosts %}
                  <tr class="host-row" data-id="{{ host.id }}" data-ip="{{ host.ip_address }}">
                    <td class="ps-4 fw-bold text-dark">{{ host.name }}</td>
                    <td class="font-monospace text-muted">{{ host.ip_address }}</td>
                    <td class="small text-muted last-checked-cell">{{ host.last_checked }}</td>
                    <td class="text-center status-cell">
                      <span class="badge bg-secondary rounded-pill">WAITING...</span>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-link text-warning" onclick="openEditModal('{{ host.id }}', '{{ host.name }}', '{{ host.ip_address }}')"><i class="bi bi-pencil-square"></i></button>
                      <button class="btn btn-sm btn-link text-danger" onclick="openDeleteModal('{{ host.id }}', '{{ host.name }}')"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="progress" style="height: 3px;">
          <div class="progress-bar bg-primary" id="progressBar" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="bi bi-robot"></i> Network AI Assistant</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="aiLoading" class="text-center py-4">
              <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;"></div>
              <p class="mt-3 text-muted">Sedang menganalisa topologi dan log jaringan...</p>
            </div>

            <div id="aiResult" class="d-none">
              <div class="alert alert-light border shadow-sm">
                <h6 class="fw-bold text-dark">Hasil Analisa:</h6>
                <p id="aiText" style="white-space: pre-line;"></p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Device</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control mb-2" id="addName" placeholder="Nama" required />
            <input type="text" class="form-control" id="addIP" placeholder="IP Address" required />
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveNewDevice()">Simpan</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <input type="text" id="editName" class="form-control mb-2" />
            <input type="text" id="editIP" class="form-control" /><button class="btn btn-warning mt-2" onclick="updateDevice()">Update</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <p>Hapus?</p>
            <input type="hidden" id="deleteId" /><button class="btn btn-danger" onclick="confirmDelete()">Hapus</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Variabel Global untuk Timer
      let intervalId = null
      let isScanning = false
      
      document.addEventListener('DOMContentLoaded', function () {
        // Jalankan cek pertama kali
        checkAllHosts()
      
        // Event Listener untuk Switch Auto Refresh
        document.getElementById('autoRefreshSwitch').addEventListener('change', function () {
          toggleAutoRefresh(this.checked)
        })
      
        // Event Listener jika Interval diubah saat sedang jalan
        document.getElementById('refreshInterval').addEventListener('change', function () {
          const isChecked = document.getElementById('autoRefreshSwitch').checked
          if (isChecked) {
            // Restart timer dengan interval baru
            toggleAutoRefresh(false)
            toggleAutoRefresh(true)
          }
        })
      })
      
      function askAI() {
        // 1. Tampilkan Modal
        const aiModal = new bootstrap.Modal(document.getElementById('aiModal'))
        aiModal.show()
      
        // 2. Reset Tampilan
        document.getElementById('aiLoading').classList.remove('d-none')
        document.getElementById('aiResult').classList.add('d-none')
      
        // 3. Panggil API Python
        fetch('/api/analyze')
          .then((response) => response.json())
          .then((data) => {
            // Sembunyikan loading
            document.getElementById('aiLoading').classList.add('d-none')
            document.getElementById('aiResult').classList.remove('d-none')
      
            if (data.success) {
              // Tampilkan teks dari AI
              document.getElementById('aiText').innerHTML = data.analysis
            } else {
              document.getElementById('aiText').innerHTML = `<span class="text-danger">Error: ${data.error}</span>`
            }
          })
          .catch((err) => {
            document.getElementById('aiLoading').classList.add('d-none')
            document.getElementById('aiResult').classList.remove('d-none')
            document.getElementById('aiText').textContent = 'Gagal menghubungi server AI.'
          })
      }
      
      function toggleAutoRefresh(enable) {
        const statusText = document.getElementById('statusText')
        const liveIndicator = document.getElementById('liveIndicator')
        const btnManual = document.getElementById('btnManualRefresh')
        const intervalMs = parseInt(document.getElementById('refreshInterval').value)
      
        if (enable) {
          // Mode ON
          statusText.textContent = 'Live Monitoring Active'
          statusText.classList.add('text-danger', 'fw-bold')
          statusText.classList.remove('text-white')
          liveIndicator.style.display = 'inline-block'
          btnManual.disabled = true
      
          // Jalankan interval
          intervalId = setInterval(() => {
            // Hanya jalankan jika scan sebelumnya sudah selesai
            if (!isScanning) {
              checkAllHosts()
            }
          }, intervalMs)
        } else {
          // Mode OFF
          statusText.textContent = 'Ready'
          statusText.classList.remove('text-danger', 'fw-bold')
          statusText.classList.add('text-white')
          liveIndicator.style.display = 'none'
          btnManual.disabled = false
      
          clearInterval(intervalId)
        }
      }
      
      function manualCheck() {
        if (!isScanning) checkAllHosts()
      }
      
      function checkAllHosts() {
        const rows = document.querySelectorAll('.host-row')
        if (rows.length === 0) return
      
        isScanning = true
        document.getElementById('progressBar').style.width = '10%'
      
        let completedRequests = 0
        const totalRequests = rows.length
      
        // Update UI jadi spinner (hanya jika bukan mode realtime yg cepat, opsional)
        // Di mode realtime, lebih baik badge tidak berubah jadi spinner semua sekaligus agar tidak pusing
        // Kita biarkan user melihat update badge secara langsung.
      
        rows.forEach((row) => {
          const id = row.getAttribute('data-id')
          const ip = row.getAttribute('data-ip')
          const statusCell = row.querySelector('.status-cell')
          const timeCell = row.querySelector('.last-checked-cell')
      
          // Visual cue kecil bahwa sedang diproses (opsional)
          // statusCell.style.opacity = "0.5";
      
          fetch('/api/ping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, ip: ip })
          })
            .then((response) => response.json())
            .then((data) => {
              //timeCell.textContent = data.last_checked.split(' ')[1] // Ambil jam saja biar singkat
              timeCell.textContent = data.last_checked // Ambil jam saja biar singkat
      
              if (data.status === 'up') {
                statusCell.innerHTML = '<span class="badge bg-success rounded-pill status-badge" data-status="up"><i class="bi bi-check-circle-fill me-1"></i>ONLINE</span>'
              } else {
                statusCell.innerHTML = '<span class="badge bg-danger rounded-pill status-badge" data-status="down"><i class="bi bi-x-circle-fill me-1"></i>OFFLINE</span>'
              }
            })
            .catch((error) => {
              console.error(error)
            })
            .finally(() => {
              completedRequests++
              // Update Progress Bar
              const percent = (completedRequests / totalRequests) * 100
              document.getElementById('progressBar').style.width = percent + '%'
      
              if (completedRequests === totalRequests) {
                isScanning = false
                updateStatsUI()
                // Reset progress bar setelah sebentar
                setTimeout(() => {
                  document.getElementById('progressBar').style.width = '0%'
                }, 500)
              }
            })
        })
      }
      
      function updateStatsUI() {
        const badges = document.querySelectorAll('.status-badge')
        let online = 0
        let offline = 0
        badges.forEach((badge) => {
          if (badge.getAttribute('data-status') === 'up') online++
          if (badge.getAttribute('data-status') === 'down') offline++
        })
        document.getElementById('online-count').textContent = online
        document.getElementById('offline-count').textContent = offline
      }
      
      // --- FUNGSI CRUD ---
      
      // 1. Tambah Device Baru
      function saveNewDevice() {
        const name = document.getElementById('addName').value
        const ip = document.getElementById('addIP').value
      
        if (!name || !ip) {
          alert('Mohon isi semua data')
          return
        }
      
        fetch('/api/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, ip: ip })
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              location.reload() // Refresh halaman agar tabel terupdate
            } else {
              alert('Gagal menambah: ' + data.error)
            }
          })
      }
      
      // 2. Buka Modal Edit
      function openEditModal(id, name, ip) {
        document.getElementById('editId').value = id
        document.getElementById('editName').value = name
        document.getElementById('editIP').value = ip
        new bootstrap.Modal(document.getElementById('editModal')).show()
      }
      
      // 3. Simpan Perubahan Edit
      function updateDevice() {
        const id = document.getElementById('editId').value
        const name = document.getElementById('editName').value
        const ip = document.getElementById('editIP').value
      
        fetch('/api/edit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, name: name, ip: ip })
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              location.reload()
            } else {
              alert('Gagal update: ' + data.error)
            }
          })
      }
      
      // 4. Buka Modal Hapus
      function openDeleteModal(id, name) {
        document.getElementById('deleteId').value = id
        document.getElementById('deleteNameDisplay').innerText = name
        new bootstrap.Modal(document.getElementById('deleteModal')).show()
      }
      
      // 5. Konfirmasi Hapus
      function confirmDelete() {
        const id = document.getElementById('deleteId').value
        fetch('/api/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              location.reload()
            } else {
              alert('Gagal menghapus: ' + data.error)
            }
          })
      }
    </script>
  </body>
</html>
